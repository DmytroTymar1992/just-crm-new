{% extends 'sales/base.html' %}

{% block title %}Деталі компанії: {{ company.name }}{% endblock %}

{% block content %}
<style>
    /* Існуючі стилі */
    .contacts-container {
        display: flex;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .contacts-list {
        width: 40%;
        background: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-height: 400px;
        overflow-y: auto;
    }

    .interactions-panel {
        width: 60%;
        background: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        max-height: 400px;
        overflow-y: auto;
        position: relative;
    }

    .interactions-panel h3 {
        font-size: 1.5rem;
        color: #2b6cb0;
        margin-bottom: 1rem;
    }

    .interaction-item {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.2s ease;
    }

    .interaction-item:hover {
        background: #f1f5f9;
    }

    .interaction-item p {
        margin: 0.5rem 0;
        font-size: 1rem;
        color: #4a5568;
    }

    .interaction-item strong {
        color: #2d3748;
    }

    .contacts-list::-webkit-scrollbar,
    .interactions-panel::-webkit-scrollbar {
        width: 8px;
    }

    .contacts-list::-webkit-scrollbar-track,
    .interactions-panel::-webkit-scrollbar-track {
        background: #e2e8f0;
        border-radius: 4px;
    }

    .contacts-list::-webkit-scrollbar-thumb,
    .interactions-panel::-webkit-scrollbar-thumb {
        background: #4b6cb7;
        border-radius: 4px;
    }

    .table tr.active {
        background: #e6f0fa;
    }

    .loading-spinner {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4b6cb7;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    @media (max-width: 768px) {
        .contacts-container {
            flex-direction: column;
        }

        .contacts-list, .interactions-panel {
            width: 100%;
        }

        .interactions-panel {
            padding: 1.5rem;
        }
    }

    /* Стилі для узгодження з interaction_item.html */
    .interaction-item .message-content {
        display: inline-block;
        padding: 10px;
        border-radius: 10px;
        background-color: #f0f0f0;
        max-width: 70%;
    }

    .interaction-item.sent .message-content {
        background-color: #0084ff;
        color: #fff;
    }

    .interaction-item.received .message-content {
        background-color: #f0f0f0;
    }

    .interaction-item.sent {
        text-align: right;
    }

    .interaction-item.received {
        text-align: left;
    }
</style>

<div class="container">
    <h1>{{ company.name }}</h1>
    <div class="card">
        <div class="card-body">
            <p><strong>Work ID:</strong> {{ company.work_id|default:"—" }}</p>
            <p><strong>Rabota ID:</strong> {{ company.rabota_id|default:"—" }}</p>
            <p><strong>Just ID:</strong> {{ company.just_id|default:"—" }}</p>
            <p><strong>Відповідальний:</strong> {{ company.responsible|default:"—" }}</p>
            <p><strong>Дата створення:</strong> {{ company.created_at|date:"d.m.Y H:i" }}</p>
            <p><strong>Слаг:</strong> {{ company.slug }}</p>
        </div>
    </div>

    <h2>Контакти компанії</h2>
    <a href="{% url 'contact_create' %}?company_id={{ company.pk }}" class="btn btn-primary">Додати контакт</a>
    <div class="contacts-container">
        <div class="contacts-list">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ім’я</th>
                        <th>Прізвище</th>
                        <th>Посада</th>
                        <th>Дата створення</th>
                    </tr>
                </thead>
                <tbody id="contacts-table">
                    {% for contact in contacts %}
                        <tr data-contact-id="{{ contact.pk }}" onclick="selectContact({{ contact.pk }})">
                            <td><a href="{% url 'contact_detail' contact.pk %}" onclick="event.stopPropagation();">{{ contact.first_name }}</a></td>
                            <td>{{ contact.last_name|default:"—" }}</td>
                            <td>{{ contact.position|default:"—" }}</td>
                            <td>{{ contact.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4">Немає контактів</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="interactions-panel" id="interactions-panel">
            <div class="loading-spinner" id="loading-spinner"></div>
            <h3 id="interactions-title">Виберіть контакт</h3>
            <div id="interactions-content"></div>
        </div>
    </div>

    <a href="{% url 'company_list' %}" class="btn btn-secondary">Назад до списку</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const contactsTable = document.getElementById('contacts-table');
    const interactionsContent = document.getElementById('interactions-content');
    const interactionsTitle = document.getElementById('interactions-title');
    const loadingSpinner = document.getElementById('loading-spinner');

    let isLoading = false;
    let currentContactId = null;
    let page = 1;
    let hasPrevious = false;

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function loadInteractions(contactId, pageNumber, append = false) {
        if (isLoading) return;
        isLoading = true;

        if (!append) {
            interactionsContent.innerHTML = '';
            interactionsTitle.textContent = 'Завантаження взаємодій...';
            loadingSpinner.style.display = 'block';
        }

        fetch(`/companies/${contactId}/interactions/?page=${pageNumber}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            loadingSpinner.style.display = 'none';
            isLoading = false;

            interactionsTitle.textContent = data.contact_name;
            if (data.html) {
                if (append) {
                    // Додаємо старіші взаємодії зверху
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.html;
                    const nodes = Array.from(tempDiv.children);
                    for (let i = nodes.length - 1; i >= 0; i--) {
                        interactionsContent.insertBefore(nodes[i], interactionsContent.firstChild);
                    }
                    // Оновлюємо позицію прокрутки
                    const newScrollHeight = interactionsContent.scrollHeight;
                    interactionsContent.scrollTop = newScrollHeight - interactionsContent.scrollHeight + interactionsContent.scrollTop;
                } else {
                    interactionsContent.innerHTML = data.html;
                    // Прокрутка донизу після рендерингу
                    setTimeout(() => {
                        interactionsContent.scrollTop = interactionsContent.scrollHeight;
                    }, 0);
                }
                hasPrevious = data.has_previous;
                page = data.page;
            } else {
                interactionsContent.innerHTML = '<p>Немає взаємодій для цього контакту.</p>';
                hasPrevious = false;
            }
        })
        .catch(error => {
            loadingSpinner.style.display = 'none';
            isLoading = false;
            interactionsTitle.textContent = 'Помилка';
            interactionsContent.innerHTML = '<p>Не вдалося завантажити взаємодії.</p>';
            showToast(`Помилка завантаження взаємодій: ${error.message}`);
            console.error('Error loading interactions:', error);
        });
    }

    window.selectContact = function(contactId) {
        // Знімаємо активний клас з усіх рядків
        contactsTable.querySelectorAll('tr').forEach(row => {
            row.classList.remove('active');
        });

        // Додаємо активний клас до вибраного рядка
        const selectedRow = contactsTable.querySelector(`tr[data-contact-id="${contactId}"]`);
        if (selectedRow) {
            selectedRow.classList.add('active');
        }

        // Скидаємо пагінацію
        currentContactId = contactId;
        page = 1;
        hasPrevious = false;

        // Завантажуємо першу сторінку
        loadInteractions(contactId, page);
    };

    // Обробка прокрутки для завантаження старіших взаємодій
    interactionsContent.addEventListener('scroll', () => {
        if (isLoading || !hasPrevious || !currentContactId) return;

        // Перевірка, чи прокручено майже до верху
        if (interactionsContent.scrollTop < 50) {
            isLoading = true;
            const previousScrollHeight = interactionsContent.scrollHeight;
            page -= 1; // Завантажуємо попередню сторінку
            loadInteractions(currentContactId, page, true);
        }
    });

    // Автоматично вибираємо перший контакт, якщо він є
    const firstContactRow = contactsTable.querySelector('tr[data-contact-id]');
    if (firstContactRow) {
        const firstContactId = firstContactRow.getAttribute('data-contact-id');
        selectContact(firstContactId);
    }
});
</script>
{% endblock %}